<!DOCTYPE html>
<html lang="en">
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />

		<title>WaifuCollector | Pack</title>

		<link rel="stylesheet" href="resources/css/all.css" />
	</head>
	<body class="scrollable" id=body>

		<%- include('partials/nav.ejs') %>
		<div id="maincard"></div>
		<div id="cards">

			<div class="page" id="page">
			  <input type="button" class="previous" value="<"></input>
				<%- `${page}/${pagemax}` %>
			  <input type="button" class="next" value=">"></input>
			</div>
			<div id="cardsinner">
			</div>
			<div class="page">
			  <input type="button" class="previous" value="<"></input>
				<%- `${page}/${pagemax}` %>
			  <input type="button" class="next" value=">"></input>
			</div>
		</div>

        <form class="nextForm" action="/card" method="get">
            <input type="hidden" name="next" value="0"/>
        </form>

        <form class="prevForm" action="/card" method="get">
            <input type="hidden" name="next" value="1"/>
        </form>

        <form class="upgrade" action="/upgrade" method="get">
            <input type="hidden" name="mainuuid" value="0"/>
            <input type="hidden" name="carduuid" value="0"/>
        </form>

	</body>

		
	<script
		src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
		crossorigin="anonymous"
	></script>
	<% if (cards != undefined) { %>
	<script>
		         const cards = <%- JSON.stringify(cards) %>;
				 const maincard = <%- JSON.stringify(maincard) %>;
		         var opn = document.getElementById('cardsinner');

		         var off = 0;
		         var tofit = [];
				for(var i = 0; i < cards.length; i++/*,off+=cardSize*/)
		         {
		           var path = cards[i].card.cardImage;
		           var posX =  off;
		           var cardhtml = `<waifu-card id=card${i} img_path=${path} frame-front=${cards[i].card.frame.path_front} frame-back=${cards[i].card.frame.path_back} pos-x=${posX} card-name=\"${cards[i].card.cardName}\" anime-name=\"${cards[i].card.type.name}\" turned=false quality=${cards[i].quality} level=${cards[i].level} uuid=${cards[i].id} cardID=${cards[i].card.cardID}  card-size=1></waifu-card>`;
				   opn.insertAdjacentHTML('beforeend',
				   cardhtml);

		           var o = document.getElementById(`card${i}`);
		           tofit.push(o);
		         }
		         opn = document.getElementById('maincard');
		     	path = maincard.cardImage;
				var posX =  off;
		 	var cardhtml = `<waifu-card id=card-main img_path=${path} frame-front=${maincard.frame.path_front} frame-back=${maincard.frame.path_back} pos-x=${posX} card-name=\"${maincard.cardName}\" anime-name=\"${maincard.type.name}\" turned=false quality=${maincard.quality} level=${maincard.level} uuid=${maincard.uuid} cardID=${maincard.cardID} card-size=1.3></waifu-card>`;
		 	opn.insertAdjacentHTML('beforeend',cardhtml);

		 	var mc = document.getElementById(`card-main`);

		window.onload = function() {
			mc.fit();
		           for(var i = 0; i < tofit.length; i++)
		           {
		             	tofit[i].fit();
		           }
		         }

		var opn = document.getElementById('body');
		var isOpen = false;
		var upform = document.querySelector('.upgrade');
         $(document).click(function(event) {
          var ele = $(event.target);
		
          if(ele.is('waifu-card') && !isOpen && ele.length != 0 && ele[0].uuid != mc.uuid)
          {
		    opn.insertAdjacentHTML('afterend',
				`<card-confirmation message="Combine?"> </card-confirmation>`);
			  isOpen = true;
			var conf = document.querySelector("card-confirmation");
			conf.yesCallback = () => {
				upform.mainuuid.value = mc.uuid;
				upform.carduuid.value = ele[0].uuid;
				upform.submit();
				isOpen = false;
			};
			conf.noCallback = () => {conf.remove(); isOpen = false;};
		  }
	 });
	</script>
	<% } %>

    <script>
      $(".next").click(()=>{
        var ele = document.querySelector(".nextForm");
        ele.submit();
      });

      $(".previous").click(()=>{
        var ele = document.querySelector(".prevForm");
        ele.submit();
      });
      
      $(".next2").click(()=>{
        var ele = document.querySelector(".nextForm");
        ele.submit();
      });

      $(".previous2").click(()=>{
        var ele = document.querySelector(".prevForm");
        ele.submit();
      });
    </script>

	<script>
		var parent = document.querySelector("#cards");
		var inv = document.querySelector("#cardsinner");
		resize();
		window.onresize = function(event) {
			resize();
		};
		function resize()
		{
			console.log();
			var amount = Math.floor((parent.offsetWidth)/ 273);
			if(amount > cards.length)
				amount = cards.length;
			if(amount <= 0)
				amount = 1;
			var size = amount * 273;
			inv.style.width = size + "px";
		}
	</script>

	<script src="../resources/components.js"></script>
</html>
