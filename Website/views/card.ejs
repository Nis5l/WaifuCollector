<!DOCTYPE html>
<html lang="en">
	<head>
		
		<%- include('partials/standard_header.ejs') %>

		<title>WaifuCollector | Card</title>

        <link rel="stylesheet" href="<%= url %>/resources/css/card.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard_sidebar.css">
		
        <style>

            .nav{

                position: fixed;
                top: 0;
                left: 0;

                box-shadow: 0px 1px 8px rgba(0, 0, 0, 0.5);

            }

        </style>

	</head>

	<form class="nextForm" action="/card" method="get">
		<input type="hidden" name="next" value="0"/>
	</form>

	<form class="prevForm" action="/card" method="get">
		<input type="hidden" name="next" value="1"/>
	</form>

	<form class="upgrade" action="/upgrade" method="get">
		<input type="hidden" name="mainuuid" value="0"/>
		<input type="hidden" name="carduuid" value="0"/>
	</form>


    <body style="overflow: hidden;">

        <%- include('partials/nav.ejs') %>

        <div class="sidebar">

            <%- include('partials/dash_nav.ejs') %>

        </div>

        <div class="dashboard_content">
			<div class="dashboard_content_wrapper" style="overflow: auto;">
				<div id="maincard"></div>
				<div id="cards" class="scrollable">
					<div id="cardsinner">
					</div>
				</div>
			</div>
        </div>
    </body>
		
	<script
		src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
		crossorigin="anonymous"
	></script>
	<script>

			var cardAmount = 0;
			var nextCards = true; 
			var opn = undefined; 

			var off = 0;
			var mc = undefined;			
			function displayCards(cards)
			{
				var cardsize = 1;
				if($(document).width() < 400) cardsize = 0.8;
				opn = document.getElementById('cardsinner');
				for(var i = 0; i < cards.length; i++/*,off+=cardSize*/)
		         {
		           var path = cards[i].card.cardImage;
		           var posX =  off;
							 var cardhtml = `<waifu-card id=card${i} img_path=${path} frame-front=${cards[i].card.frame.path_front} frame-back=${cards[i].card.frame.path_back} pos-x=${posX} card-name=\"${cards[i].card.cardName}\" anime-name=\"${cards[i].card.type.name}\" turned=false quality=${cards[i].quality} level=${cards[i].level} uuid=${cards[i].id} cardID=${cards[i].card.cardID}  card-size=${cardsize} effect_path="${cards[i].card.effect}"></waifu-card>`;
				   opn.insertAdjacentHTML('beforeend',
				   cardhtml);

		           var o = document.getElementById(`card${i}`);
				   cardAmount++;
		         }
				nextCards = true;
			}

			function displayMain(maincard)
			{
				var cardsize = 1.3;
				if($(document).width() < 400) cardsize = 1;
		        opn = document.getElementById('maincard');
		     	path = maincard.cardImage;
				var posX =  off;
						var cardhtml = `<waifu-card id=card-main img_path=${path} frame-front=${maincard.frame.path_front} frame-back=${maincard.frame.path_back} pos-x=${posX} card-name=\"${maincard.cardName}\" anime-name=\"${maincard.type.name}\" turned=false quality=${maincard.quality} level=${maincard.level} uuid=${maincard.uuid} cardID=${maincard.cardID} card-size=${cardsize}  effect_path="${maincard.effect}" style="margin:auto"></waifu-card>`;
				opn.insertAdjacentHTML('beforeend',cardhtml);

				mc = document.getElementById(`card-main`);
			}

		var isOpen = false;
		var upform = document.querySelector('.upgrade');
         $(document).click(function(event) {
          var ele = $(event.target);
		
          if(ele.is('waifu-card') && !isOpen && ele.length != 0 && ele[0].uuid != mc.uuid)
          {
		    document.body.insertAdjacentHTML('afterend',
				`<card-confirmation message="Combine?"> </card-confirmation>`);
			  isOpen = true;
			var conf = document.querySelector("card-confirmation");
			conf.yesCallback = () => {
				upform.mainuuid.value = mc.uuid;
				upform.carduuid.value = ele[0].uuid;
				upform.submit();
				isOpen = false;
			};
			conf.noCallback = () => {conf.remove(); isOpen = false;};
		  }
	 });
	</script>

    <script>
      $(".next").click(()=>{
        var ele = document.querySelector(".nextForm");
        ele.submit();
      });

      $(".previous").click(()=>{
        var ele = document.querySelector(".prevForm");
        ele.submit();
      });
      
      $(".next2").click(()=>{
        var ele = document.querySelector(".nextForm");
        ele.submit();
      });

      $(".previous2").click(()=>{
        var ele = document.querySelector(".prevForm");
        ele.submit();
      });
    </script>

	<script>
		var parent = document.querySelector("#cards");
		var inv = document.querySelector("#cardsinner");
		resize();
		window.onresize = function(event) {
			resize();
		};
		function resize()
		{
			var cwidth = 273; 
			if($(document).width() < 400) cwidth = 218;
			var amount = Math.floor((parent.offsetWidth)/ cwidth);
			if(amount > cardAmount)
				amount = cardAmount;
			if(amount <= 0)
				amount = 1;
			var size = amount * cwidth;
			inv.style.width = size + "px";
		}
	</script>

	<script>

		var scroll = document.querySelector(".scrollable");
		var page = 0;
		var pageamount = 1;
		loadCards(true);
		scroll.onscroll = function(ev) {
			if (scroll.scrollHeight - scroll.scrollTop - scroll.clientHeight < 1) {
				loadCards();
			}
		};

		var mcdiv = document.getElementById('maincard');

		function loadCards(first) {
			if(first)
			{
				page = 0;
				pageamount = 1;
			}
			if(nextCards && page < pageamount)
			{
			  var xhttp = new XMLHttpRequest();
			  xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var json = JSON.parse(this.response);
					page = json.page;
					pageamount = json.pagemax;
					if(mcdiv.innerHTML == "")
						displayMain(json.maincard);
					displayCards(json.cards);
					resize();
					if (scroll.scrollHeight - scroll.scrollTop - scroll.clientHeight < 1)
					{
						loadCards();
					}
				}
			}
			  nextCards = false;
			  xhttp.open("POST", "/card", true);
			  xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
				if(!first)
					xhttp.send(JSON.stringify({uuid: <%- uuid %>, next: 0}));
				else
					xhttp.send(JSON.stringify({uuid:<%- uuid %>, page: 0}));
		  };
		}
	</script>

	<script src="../resources/components.js"></script>
    <%- include('partials/error.ejs') %>
</html>
