<!DOCTYPE html>
<html lang="en">
	<head>
		
		<%- include('partials/standard_header.ejs') %>

		<title>WaifuCollector | Card</title>

        <link rel="stylesheet" href="<%= url %>/resources/css/card.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard_sidebar.css">
		
        <style>

            .nav{

                position: fixed;
                top: 0;
                left: 0;

                box-shadow: 0px 1px 8px rgba(0, 0, 0, 0.5);

            }

        </style>

	</head>

	<form class="nextForm" action="/card" method="get">
		<input type="hidden" name="next" value="0"/>
	</form>

	<form class="prevForm" action="/card" method="get">
		<input type="hidden" name="next" value="1"/>
	</form>

	<form class="upgrade" action="/upgrade" method="get">
		<input type="hidden" name="mainuuid" value="0"/>
		<input type="hidden" name="carduuid" value="0"/>
	</form>


    <body style="overflow: hidden;">

        <%- include('partials/nav.ejs') %>

        <div class="sidebar">

            <%- include('partials/dash_nav.ejs') %>

        </div>

        <div class="dashboard_content">
			<div class="dashboard_content_wrapper" style="overflow: auto;">
				<div id="maincard"></div>
				<div id="cards" class="scrollable">
					<div id="cardsinner">
					</div>
				</div>
			</div>
        </div>
    </body>
		
	<script
		src="https://code.jquery.com/jquery-3.5.1.min.js"
		integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
		crossorigin="anonymous"
	></script>

    <%- include('partials/insert_cards.ejs') %>

	<script>
		var maincarduuid = -1;
		var cardid = 0;
		var opn = document.getElementById('cardsinner'); 
		var mainopn = document.getElementById('maincard');
		
		var isOpen = false;
		var upform = document.querySelector('.upgrade');
    	$(document).click(function(event) {
    	var ele = $(event.target);
		
    	if(ele.is('waifu-card') && !isOpen && ele.length != 0 && ele[0].uuid != maincarduuid)
    	{
			document.body.insertAdjacentHTML('afterend', `<card-confirmation message="Combine?"> </card-confirmation>`);
			isOpen = true;
			var conf = document.querySelector("card-confirmation");
			conf.yesCallback = () => {
				upform.mainuuid.value = maincarduuid;
				upform.carduuid.value = ele[0].uuid;
				upform.submit();
				isOpen = false;
			};
			conf.noCallback = () => {conf.remove(); isOpen = false;};
		  }
	 });
	</script>

    <script>
      $(".next").click(()=>{
        var ele = document.querySelector(".nextForm");
        ele.submit();
      });

      $(".previous").click(()=>{
        var ele = document.querySelector(".prevForm");
        ele.submit();
      });
      
      $(".next2").click(()=>{
        var ele = document.querySelector(".nextForm");
        ele.submit();
      });

      $(".previous2").click(()=>{
        var ele = document.querySelector(".prevForm");
        ele.submit();
      });
    </script>

	<script>
		var parent = document.querySelector("#cards");
		var inv = document.querySelector("#cardsinner");
		resize();
		window.onresize = function(event) {
			resize();
		};
		function resize()
		{
			var cwidth = 273; 
			if($(document).width() < 400) cwidth = 218;
			var amount = Math.floor((parent.offsetWidth)/ cwidth);
			if(amount > cardid)
				amount = cardid;
			if(amount <= 0)
				amount = 1;
			var size = amount * cwidth;
			inv.style.width = size + "px";
		}
	</script>

	<script>

		var scroll = document.querySelector(".scrollable");
		var page = 0;
		var pageamount = 1;
		loadCards(true);
		scroll.onscroll = function(ev) {
			if (scroll.scrollHeight - scroll.scrollTop - scroll.clientHeight < 1) {
				loadCards();
			}
		};

		function loadCards(first) {
			if(first)
			{
				page = 0;
				pageamount = 1;
			}
			
			var size = 1;
			var mainsize = 1.3;
			if($(document).width() < 400)
			{
				size = 0.8;
				mainsize = 1;
			}
			
			if(page < pageamount)
			{
				
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						var json = JSON.parse(this.response);
						page = json.page;
						pageamount = json.pagemax;
						maincarduuid = json.maincard.id;
						if(mainopn.innerHTML == "") insertcards([json.maincard], mainopn, false, mainsize);
						insertcards(json.cards, opn, false, size);
						resize();
						if (scroll.scrollHeight - scroll.scrollTop - scroll.clientHeight < 1)
						{
							loadCards();
						}
					}
				}
				xhttp.open("POST", "/card", true);
				xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
				if(!first)
					xhttp.send(JSON.stringify({uuid: <%- uuid %>, next: 0}));
				else
					xhttp.send(JSON.stringify({uuid:<%- uuid %>, page: 0}));
		  };
		}
	</script>

	<script src="../resources/components.js"></script>
    <%- include('partials/error.ejs') %>
</html>
