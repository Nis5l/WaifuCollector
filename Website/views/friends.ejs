<!DOCTYPE html>
<html lang="en">
    <head>

        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">

        <title>WaifuCollector | Pack</title>

        <link rel="stylesheet" href="resources/css/all.css">
    </head>
    <body id="body" class="scrollable">

        <%- include('partials/nav.ejs') %>
       	<div class=friendbox> 
            <form class="tradeform" action="/trade" method="get">
				<input type="hidden" name="userID" value=""/>
			</form>
			<input class="addfriend" type="submit" value="Add Friend" name="submit"></input>

			<form class="addfriendform" action="/addfriend" method="post">
				<input type="hidden" name="username" value=""/>
			</form>

			<form class="managefriendform" action="/managefriend" method="post">
				<input type="hidden" name="userID" value=""/>
				<input type="hidden" name="command" value=""/>
			</form>

			<div id="friends">
			</div>
			
			<div class="bot"></div>
		<div>
    </body>

    <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>

	<script>
        const friends = <%- JSON.stringify(friends) %>;
		var opn = document.getElementById('friends');
		for(var i = 0; i < friends.length; i++)
		{
			//console.log(friends[i]);
			var cardhtml = `<friend-card username=\"${friends[i].username}\" userID=${friends[i].userID} status=${friends[i].status}> </friend-card>`;
            opn.insertAdjacentHTML('beforeend', cardhtml);
		}
	</script>

	<script>
		var isOpen = false;
		var opn = document.getElementById('body');
		var form = document.querySelector(".addfriendform");
		var conf = undefined;
		$(".addfriend").click(()=>{
			if(!isOpen)
			{
				opn.insertAdjacentHTML('afterend',
					`<add-friend> </add-friend>`);
				isOpen = true;
				conf = document.querySelector("add-friend");
				conf.yesCallback = () => {
					form.username.value = conf.username.value;
					form.submit();
					conf.remove();
					isOpen = false;
				};
				conf.noCallback = () => {conf.remove(); isOpen = false;};
			}
		});
	
		
		var manageform = document.querySelector(".managefriendform");
         $(document).click(function(event) {
          var ele = $(event.target);
		
          if(ele.is('friend-card') && !isOpen)
          {
			  if(ele[0].status=="0")
			  {
				opn.insertAdjacentHTML('afterend',
					`<card-confirmation message="Befriend?"> </card-confirmation>`);
				  isOpen = true;
				conf = document.querySelector("card-confirmation");
				conf.yesCallback = () => {
					manageform.userID.value = ele[0].userID;
					manageform.command.value = 0;
					manageform.submit();
					conf.remove();
					isOpen = false;
				};
				  conf.noCallback = () =>
				  {
					manageform.userID.value = ele[0].userID;
					manageform.command.value = 1;
					manageform.submit();
					conf.remove();
					isOpen = false;
				  };
			  }else if(ele[0].status == "2")
			  {
				opn.insertAdjacentHTML('afterend',
					`<friend-selection username="${ele[0].username}"> </friend-selection>`);
				  isOpen = true;
				  conf = document.querySelector("friend-selection");
				  conf.deleteCallback = () => {
					  conf.remove();
					opn.insertAdjacentHTML('afterend',
						`<card-confirmation message="Delete?"> </card-confirmation>`);
					  isOpen = true;
					conf = document.querySelector("card-confirmation");
					conf.yesCallback = () => {
						manageform.userID.value = ele[0].userID;
						manageform.command.value = 1;
						manageform.submit();
						conf.remove();
						isOpen = false;
					};
					  conf.noCallback = () =>
					  {
						conf.remove();
						isOpen = false;
					  };
				  };
				  conf.tradeCallback = () => {
					var f = document.querySelector(".tradeform");
					f.userID.value = ele[0].userID;
					f.submit();
				  }
			  }
		  }else if(!ele.is('friend-selection') && !ele.is('card-confirmation') && !ele.is('add-friend') && !ele.is('input') && isOpen)
		  {
			isOpen = false;
			conf.remove();
		  }
		});
	</script>
	

	<script>
		var inv = document.querySelector("#friends");
        //const friends = <%- JSON.stringify(friends) %>;
		resize();
		window.onresize = function(event) {
			resize();
		};
		function resize()
		{
			var amount = Math.floor(document.body.offsetWidth / 300);
			if(amount > friends.length)
				amount = friends.length;
			if(amount <= 0)
				amount = 1;
			var size = amount * 300;
			inv.style.width = size + "px";
}
	</script>
	
    <script src="../resources/components.js"></script> 
</html>
