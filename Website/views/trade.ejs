<!DOCTYPE html>
<html lang="en">
    <head>

		<%- include('partials/standard_header.ejs') %>

		<title>WaifuCollector | Trade</title>
		
		<link rel="stylesheet" href="<%= url %>/resources/css/trade.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard_sidebar.css">

        <style>
            .nav{
                position: fixed;
                top: 0;
                left: 0;
                box-shadow: 0px 1px 8px rgba(0, 0, 0, 0.5);
            }
        </style>


    </head>

	<form class="addtradeform" action="/tradeinventory" method="get">
		<input type="hidden" name="userID" value="<%-userID%>"/>
	</form>
	<form class="addtradeotherform" action="/tradeinventory" method="get">
		<input type="hidden" name="userID" value="<%-userID%>"/>
		<input type="hidden" name="friend" value="true"/>
	</form>
	<form class="oktradeform" action="/oktrade" method="post">
		<input type="hidden" name="userID" value="<%-userID%>"/>
	</form>
	<form class="removetradeform" action="/removetrade" method="post">
		<input type="hidden" name="userID" value="<%-userID%>"/>
		<input type="hidden" name="cardID" value=""/>
	</form>
	<form class="removesuggestionform" action="/removesuggestion" method="post">
		<input type="hidden" name="userID" value="<%-userID%>"/>
		<input type="hidden" name="cardID" value=""/>
	</form>
	<form class="removesuggestionformfriend" action="/removesuggestion" method="post">
		<input type="hidden" name="userID" value="<%-userID%>"/>
		<input type="hidden" name="cardID" value=""/>
		<input type="hidden" name="friend" value="true"/>
	</form>
	<form class="acceptsuggestionform" action="/acceptsuggestion" method="post">
		<input type="hidden" name="userID" value="<%-userID%>"/>
		<input type="hidden" name="cardID" value=""/>
	</form>

    <body style="overflow: hidden;">

        <%- include('partials/nav.ejs') %>

        <div class="sidebar">

            <%- include('partials/dash_nav.ejs') %>

        </div>

        <div class="dashboard_content">
			<div class="dashboard_content_wrapper">
				<div class="trade scrollable">
					<div class="trades">
					<div id="tradeself">
						<div class="name">You</div>
						<div class=""><%- tradeCount1 + "/" + tradeLimit %></div>
						<div class="confirmationself"></div>
					<div id="tradeselfinner">
					</div>
					</div>
					<div id="tradeother">
						<div class="name"><%- username %></div>
						<div class=""><%- tradeCount2 + "/" + tradeLimit %></div>
						<div class="confirmationother"></div>
						<div id="tradeotherinner">
						</div>
					</div>
					</div>
					<input type="button" class="addtrade" style="float: left; margin-left: 2%" value="Add Card"></input>
					<input type="button" class="addtradeother" style="float: right; margin-right: 2%" value="Suggest Card"></input>
					<input type="button" class="oktrade" value="Confirm"></input>
				</div>
			</div>
        </div>
    </body>
	
	<script
	src="https://code.jquery.com/jquery-3.5.1.min.js"
	integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
	crossorigin="anonymous"></script>

	<script>
	 	const cs = <%- JSON.stringify(statusone) %>;
		const co = <%- JSON.stringify(statustwo) %>;
        var tradeTime = <%-tradeTime%>
        const tradeinterval = setInterval(() => {
            updateTradeTime();
            if(tradeTime == 0)
            {
                clearInterval(tradeinterval);
            }
        }, update);
        function updateTradeTime()
        {
            tradeTime -= update;
            if (tradeTime <= 0) tradeTime = 0;
			if (typeof tradeTime !== "undefined") updateTradeTimeIndication();
            return 0;
        }

		if(<%- tradeCount1 >= tradeLimit%>)
		{
			document.querySelector('.addtrade').disabled = true;
		}

		<!--if(<%- tradeCount2 >= tradeLimit%>)-->
		<!--{-->
			<!--document.querySelector('.addtradeother').disabled = true;-->
		<!--}-->
		function updateTradeTimeIndication()
		{
			var disabled = false;
			var message = "Confirm";

			if(<%=tradeLimitReached%>)
			{
				message = "Tradelimit Reached";
				disabled = true;
			}

			if(tradeTime != 0)
			{
				message = formatTime(tradeTime);
				disabled = true;
			}
	
			if(cs != 0)
			{
				disabled = true;
				message = "Already Confirmed";
			}

			document.querySelector('.oktrade').disabled = disabled;
			document.querySelector('.oktrade').value = message;
		}
		onloadFuncs.push(() => {
		  var xtradehttp = new XMLHttpRequest();
		  xtradehttp.onreadystatechange = function() {
			if (this.readyState == 4 && this.status == 200) {
				var json = JSON.parse(this.response);
				tradeTime = json.tradeTime;
			}
		  }
		  xtradehttp.open("POST", "/tradeTime", true);
		  xtradehttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
		  xtradehttp.send(JSON.stringify({userID: <%-userID%>}));
		});
	</script>

    <%- include('partials/insert_cards.ejs') %>

	<script>
		var cardid = 0;
		const cards = <%- JSON.stringify(cards) %>;
		const cardsuggestions = <%- JSON.stringify(cardsuggestions) %>;
		const cardscount = cards.length + cardsuggestions.length;
		const cardsfriend = <%- JSON.stringify(cardsfriend) %>;
		const cardsuggestionsfriend = <%- JSON.stringify(cardsuggestionsfriend) %>;
		const cardscountfriend = cardsfriend.length + cardsuggestionsfriend.length;
		var opn = document.getElementById('tradeselfinner');
		var opnother = document.getElementById('tradeotherinner');
		insertcards(cardsuggestions, opn, false, 1, "#ddffdea8", "suggestion");
		insertcards(cards, opn, false, 1);
		insertcards(cardsuggestionsfriend, opnother, false, 1, "#ddffdea8", "suggestion");
		insertcards(cardsfriend, opnother, false, 1);
	</script>
	<script>
      $(".addtrade").click(()=>{
        var ele = document.querySelector(".addtradeform");
        ele.submit();
      });
      $(".addtradeother").click(()=>{
        var ele = document.querySelector(".addtradeotherform");
        ele.submit();
      });
      $(".oktrade").click(()=>{
        var ele = document.querySelector(".oktradeform");
        ele.submit();
      });
	</script>

	<script>
		var removeForm = document.querySelector(".removetradeform")	
		var removeSuggestionForm = document.querySelector(".removesuggestionform")	
		var removeSuggestionFormFriend = document.querySelector(".removesuggestionformfriend")	
		var acceptSuggestionForm = document.querySelector(".acceptsuggestionform")	
		var isOpen = false;
		$(document).click(function(event) {
		var ele = $(event.target);
		
		if(ele.is('waifu-card') && !isOpen)
		{
			if(ele[0].parentElement.id == "tradeselfinner")
			{
				if(ele[0].identifier == "suggestion")
				{
					document.body.insertAdjacentHTML('afterend', `<card-confirmation-cancel message="Accept Suggestion?"> </card-confirmation-cancel>`);
					isOpen = true;
					var conf = document.querySelector("card-confirmation-cancel");
					conf.yesCallback = () => {
						acceptSuggestionForm.cardID.value = ele[0].uuid;
						acceptSuggestionForm.submit();
						isOpen = false;
					};
					conf.noCallback = () => 
					{
						removeSuggestionForm.cardID.value = ele[0].uuid;
						removeSuggestionForm.submit();
						isOpen = false;
					};
					conf.cancelCallback = () => {conf.remove(); isOpen = false;};
				}else
				{
					document.body.insertAdjacentHTML('afterend', `<card-confirmation message="Remove From Trade?"> </card-confirmation>`);
					isOpen = true;
					var conf = document.querySelector("card-confirmation");
					conf.yesCallback = () => {
						removeForm.cardID.value = ele[0].uuid;
						removeForm.submit();
						isOpen = false;
					};
					conf.noCallback = () => {conf.remove(); isOpen = false;};
				}
			}else
			{
				if(ele[0].identifier == "suggestion")
				{
					document.body.insertAdjacentHTML('afterend', `<card-confirmation message="Delete Suggestion?"> </card-confirmation>`);
					isOpen = true;
					var conf = document.querySelector("card-confirmation");
					conf.yesCallback = () => {
						removeSuggestionFormFriend.cardID.value = ele[0].uuid;
						removeSuggestionFormFriend.submit();
						isOpen = false;
					};
					conf.noCallback = () => {conf.remove(); isOpen = false;};
				}
			}
		}
	});
	</script>

	<script>
		var parentself = document.querySelector("#tradeself");
		var inventory = document.querySelector("#tradeselfinner");
		var parentother = document.querySelector("#tradeother");
		var inventoryother = document.querySelector("#tradeotherinner");
		resize(inventory, parentself, cardscount);
		resize(inventoryother, parentother, cardscountfriend);
		window.onresize = function(event) {
			resize(inventory, parentself, cardscount);
			resize(inventoryother, parentother, cardscountfriend);
		};
		function resize(inv, parent, c)
		{
			var amount = Math.floor((parent.offsetWidth)/ 273);
			if(amount > c.length)
				amount = c.length;
			if(amount <= 0)
				amount = 1;
			var size = amount * 273;
			inv.style.width = size + "px";
	 	const cs = <%- JSON.stringify(statusone) %>;
		const co = <%- JSON.stringify(statustwo) %>;
		}
	</script>

	<script>
		var csf = document.querySelector(".confirmationself");
		var cof = document.querySelector(".confirmationother");
		if(cs == 0)
			csf.innerHTML = "Not Confirmed";
		else
			csf.innerHTML = "Confirmed";
		if(co == 0)
			cof.innerHTML = "Not Confirmed";
		else
			cof.innerHTML = "Confirmed";
	</script>
	
	<script src="../resources/components.js"></script>
    <%- include('partials/error.ejs') %>
</html>
