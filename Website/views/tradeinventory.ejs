<!DOCTYPE html>
<html lang="en">
    <head>

        <%- include('partials/standard_header.ejs') %>

        <title>WaifuCollector | TradeInventory</title>

        <link rel="stylesheet" href="<%= url %>/resources/css/inventory.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard.css">
        <link rel="stylesheet" href="<%= url %>/resources/css/dashboard_sidebar.css">

        <style>

            .nav{

                position: fixed;
                top: 0;
                left: 0;

                box-shadow: 0px 1px 8px rgba(0, 0, 0, 0.5);

            }

        </style>


    </head>

	<form class="cardForm" action="/card" method="get">
		<input type="hidden" name="uuid" value="1"/>
	</form>

	<form class="addForm" action="/addtrade" method="post">
		<input type="hidden" name="userID" value="<%-friendID%>"/>
		<input type="hidden" name="cardID" value=""/>
	</form>

    <body style="overflow: hidden;">

        <%- include('partials/nav.ejs') %>

        <div class="sidebar">

            <%- include('partials/dash_nav.ejs') %>

        </div>

        <div class="dashboard_content">
			<div class="dashboard_content_wrapper scrollable">
				<form class="filter" action="#" onsubmit="onfilter(); return false">
					<input type="search" name="search" placeholder=""/>
					<br>
					<div class="radio_wrap">
						<label class="radio">
						  <span class="radio__input">
							<input type="radio" checked="checked" name="sortType">
							<span class="radio__control"></span>
						  </span>
						  <span class="radio__label">Name</span>
						</label>

						<label class="radio">
						  <span class="radio__input">
							<input type="radio" name="sortType">
							<span class="radio__control"></span>
						  </span>
						  <span class="radio__label">Level</span>
						</label>
					</div>
					<br>
					<input type="submit" value="Search" name="submit"></input>
				</form>

				<div id="inventory">
				</div>
				
			</div>
        </div>
    </body>

    <script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous"></script>

        <script>

            var nextCards = true; 
            var cardAmount = 0;
            var opn = document.getElementById('inventory');
            //displayCards(lcards);
            
            function displayCards(cards)
            {
                //var cardSize = 110;
                //var off = 235-(cards.length-1) / 2 * cardSize;
                var off = 0;           
                for(var i = 0; i < cards.length; i++/*,off+=cardSize*/)
                {
                    cardAmount++;
                  var path = cards[i].card.cardImage;
                  var posX =  off;
                    //console.log(cards[i].cardID + " " + cards[i].card.cardName);
								var cardhtml = `<waifu-card id=card${i} img_path=${path} frame-front=${cards[i].card.frame.path_front} frame-back="" pos-x=${posX} card-name=\"${cards[i].card.cardName}\" anime-name=\"${cards[i].card.type.name}\" turned=false quality=${cards[i].quality} level=${cards[i].level} uuid=${cards[i].id} cardID=${cards[i].cardID} card-size=1 effect_path="${cards[i].card.effect}"></waifu-card>`;
                  opn.insertAdjacentHTML('beforeend',
                  cardhtml);
                
                  var o = document.getElementById(`card${i}`);
                }
                nextCards = true;
            }

        </script>


    <script>
		var inv_wrapper = document.querySelector(".dashboard_content_wrapper");
        var inv = document.querySelector("#inventory");
        resize();
        window.onresize = function(event) {
            resize();
        };
        function resize()
        {
            var amount = Math.floor(inv_wrapper.offsetWidth / 273);
            if(amount > cardAmount)
                amount = cardAmount;
            if(amount <= 0)
                amount = 1;
            var size = amount * 273;
            inv.style.width = size + "px";
}
    </script>

	<script>

		var scroll = document.querySelector(".scrollable");
		var filter = document.querySelector(".filter");
		var page = 0;
		var pageamount = 1;
		loadCards(true);
		scroll.onscroll = function(ev) {
			if (scroll.scrollHeight - scroll.scrollTop - scroll.clientHeight < 1) {
				loadCards();
			}
		};

		function loadCards(first) {
			if(first)
			{
				page = 0;
				pageamount = 1;
			}
			if(nextCards && page < pageamount)
			{
			  var xhttp = new XMLHttpRequest();
			  xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var json = JSON.parse(this.response);
					page = json.page;
					pageamount = json.pagemax;
					displayCards(json.cards);
					resize();
					if (scroll.scrollHeight - scroll.scrollTop - scroll.clientHeight < 1)
						loadCards();
				}
			}

			  var radios = document.getElementsByName('sortType');
			  var radioValue = undefined;
			  for (var i = 0, length = radios.length; i < length; i++) {
			    if (radios[i].checked) {
				  radioValue = i;
				  break;
			    }
			  }
			  nextCards = false;
			  xhttp.open("POST", "/inventory", true);
			  xhttp.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                if(!first)
					xhttp.send(JSON.stringify({ next: 0, userID: <%-friendID%>, search: filter.search.value, sortType: radioValue}));
                else
					xhttp.send(JSON.stringify({ page: 0, userID: <%-friendID%>, search: filter.search.value, sortType: radioValue}));
          };
        }
    </script>

    <script>
        var f = document.querySelector(".addForm");
         $(document).click(function(event) {
          var ele = $(event.target);
        
          if(ele.is('waifu-card'))
          {
            opn.insertAdjacentHTML('afterend',
                `<card-confirmation message="Add Card?"> </card-confirmation>`);
              isOpen = true;
            conf = document.querySelector("card-confirmation");
            conf.yesCallback = () => {
                f.cardID.value = ele[0].uuid;
                f.submit();
                conf.remove();
                isOpen = false;
            };
              conf.noCallback = () =>
              {
                conf.remove();
                isOpen = false;
              };
          }
        }); 
    </script>

	<script>
		function onfilter()
		{
			cardAmount = 0;
			inventory.innerHTML = "";
			loadCards(true);
		}
	</script>

    <script src="../resources/components.js"></script> 
    <%- include('partials/error.ejs') %>
</html>
